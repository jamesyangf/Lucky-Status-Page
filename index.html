<!-- James Yang -->

<!DOCTYPE html>
<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="main.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>

<div class="LogoWrapper">
    <img src="img/SplashPage_Logo_03.png" alt="Lucky Brand Logo">
</div>

<section>
	<h1 class="section-header"> System Statuses </h1>
	<p class="note"> NOTE: "Under Maintenance" is set by a Critical Ticket or Manually set by administrator </p>
	<form action="AddTicket.html">
		<input type="submit" value="Create a Ticket" class="btn btn-navy btn-border-o">
 	</form>

    <ul class="list">
	    <div>
	        <div class="header_container direct">
	        	<i id="icon_plus" class="fa fa-plus-square-o"></i>
	    		<i id="icon_minus" class="fa fa-minus-square-o" style="display: none"></i>
	        	<strong>Lucky Direct</strong>
	        	<div class="pull-right direct">
	        		Operational
	        	</div>
	        </div>
	        <div class="item_group">
	        	
	            <a href="Boris/boris.html"><div class=item_container>
	            	Boris
	            	<div class="pull-right direct1">
	        			Operational
	        		</div>
	            </div></a>
	            
	            <a href="LDOrder/ldorder.html"><div class=item_container>
	            	LD Order Allocation
	            	<div class="pull-right direct2">
	        			Operational
	        		</div>
	            </div></a>
	          
	            <a href="Pickup/pickup.html"><div class=item_container>
	            	In Store Pickup
	            	<div class="pull-right direct3">
	        			Operational
	        		</div>
	            </div></a>
	        </div>                
	    </div>
	</ul>

	<ul class="list">
	    <div>
	        <div class="header_container sale">
	        	<i id="icon_plus" class="fa fa-plus-square-o"></i>
	    		<i id="icon_minus" class="fa fa-minus-square-o" style="display: none"></i>
	        	<strong>Point of Sale Systems</strong>
	        	<div class="pull-right sale">
	        		Operational
	        	</div>
	        </div>
	        <div class="item_group">
	        	
	            <a href="MiStore/mistore.html"><div class=item_container>
	            	MiStore Devices
	            	<div class="pull-right sale1">
	        			Operational
	        		</div>
	            </div></a>
	            
	            <a href="Promotions/promotions.html"><div class=item_container>
	            	Promotions
	            	<div class="pull-right sale2">
	        			Operational
	        		</div>
	            </div></a>
	          
	            <a href="Pricing/pricing.html"><div class=item_container>
	            	Pricing
	            	<div class="pull-right sale3">
	        			Operational
	        		</div>
	            </div></a>
	        </div>                
	    </div>
	</ul>

	<ul class="list">
	    <div>
	        <div class="header_container sale">
	        	<i id="icon_plus" class="fa fa-plus-square-o"></i>
	    		<i id="icon_minus" class="fa fa-minus-square-o" style="display: none"></i>
	        	<strong>Ecommerce</strong>
	        	<div class="pull-right ecom">
	        		Operational
	        	</div>
	        </div>
	        <div class="item_group">
	        	
	            <a href="EcomSys/ecom.html"><div class=item_container>
	            	Ecommerce Systems
	            	<div class="pull-right ecom1">
	        			Operational
	        		</div>
	            </div></a>

	            <a href="Orders/orders.html"><div class=item_container>
	            	Orders & Order Statuses
	            	<div class="pull-right ecom2">
	        			Operational
	        		</div>
	            </div></a>

	            <a href="LuckyBrand_com/luckybrand.html"><div class=item_container>
	            	www.LuckyBrand.com
	            	<div class="pull-right ecom3">
	        			Operational
	        		</div>
	            </div></a>
	        </div>                
	    </div>
	</ul>

	<ul class="list">
	    <div>
	        <div class="header_container sale">
	        	<i id="icon_plus" class="fa fa-plus-square-o"></i>
	    		<i id="icon_minus" class="fa fa-minus-square-o" style="display: none"></i>
	        	<strong>Corporate Systems</strong>
	        	<div class="pull-right corp">
	        		Operational
	        	</div>
	        </div>
	        <div class="item_group">
	        	
	            <a href="Manhattan/manhattan.html"><div class=item_container>
	            	Manhattan Molecule
	            	<div class="pull-right corp1">
	        			Operational
	        		</div>
	            </div></a>

	            <a href="ASNtoGSI/ASNtoGSI.html"><div class=item_container>
	            	ASN's to GSI
	            	<div class="pull-right corp2">
	        			Operational
	        		</div>
	            </div></a>
	        </div>                
	    </div>
	</ul>
	<form action="edit.html">
		<input type="submit" value="Edit System Statuses" class="btn btn-navy btn-border-o">
	</form>
</section>


<!-- <section>
  <h1 class="section-header">OpsGenie Tickets</h1>
  <div class="tbl-header">
    <table cellpadding="0" cellspacing="0" border="0">
      <thead>
        <tr>
          <th>Message</th>
          <th>Status</th>
          <th>Owner</th>
          <th>Team</th>
          <th>Created At</th>
        </tr>
      </thead>
    </table>
  </div>
  <div class="tbl-content">
    <table cellpadding="0" cellspacing="0" border="0">
      <tbody class="OpsGenie">
      </tbody>
    </table>
  </div>
</section> -->

<style> 
	ul div .item_group {
	    display: none;
	} 
</style>

<script>
	$('.list > div .header_container').click(function() {
	    $(this).parent().find('.item_group').toggle();
	    $(this).parent().find("#icon_plus").toggle();
	    $(this).parent().find("#icon_minus").toggle();

	});



	function determineColor(item) {
		var val = item.text().trim();

		var good = "Operational";
		var partial = "Partial Outage";
		var maint = "Under Maintenance";
		var degraded = "Degraded Performance";
		var major = "Major Outage";
		
		if(val == good) {
			item.css('color', '#7ED321');
		} else if(val == major) {
			item.css('color', "rgb(231, 76, 60)");
		} else if(val == partial) {
			item.css('color', '#e67e22');
		} else if(val == degraded) {
			item.css('color', 'rgb(241, 196, 15)');
		} else if(val == maint) {
			item.css('color', "rgb(52, 152, 219)");
		}
	}

	// Gets the status from edit page here TODO
	determineColor($(".pull-right.direct1"));
	determineColor($(".pull-right.direct2"));
	determineColor($(".pull-right.direct3"));
	determineColor($(".pull-right.sale1"));
	determineColor($(".pull-right.sale2"));
	determineColor($(".pull-right.sale3"));
	determineColor($(".pull-right.ecom1"));
	determineColor($(".pull-right.ecom2"));
	determineColor($(".pull-right.ecom3"));
	determineColor($(".pull-right.corp1"));
	determineColor($(".pull-right.corp2"));



	// For updating the Catagory header
	function statusLuckyDirect() {
		var good = "Operational";
		var partial = "Partial Outage";
		var maint = "Under Maintenance";
		var degraded = "Degraded Performance";
		var major = "Major Outage";

		var row1 = $(".pull-right.direct1").text().trim();
		var row2 = $(".pull-right.direct2").text().trim();
		var row3 = $(".pull-right.direct3").text().trim();

		// The status ladder, strongest status first
		if(row2 == major || row1 == major || row3 == major) {
			$(".pull-right.direct").text(major);
			$(".pull-right.direct").css('color', "rgb(231, 76, 60)");
		} else if(row2 == partial || row1 == partial || row3 == partial) {
			$(".pull-right.direct").text(partial);
			$(".pull-right.direct").css('color', '#e67e22');
		} else if(row2 == degraded || row1 == degraded || row3 == degraded) {
			$(".pull-right.direct").text(degraded);
			$(".pull-right.direct").css('color', 'rgb(241, 196, 15)');
		} else if(row2 == maint || row1 == maint || row3 == maint) {
			$(".pull-right.direct").text(maint);
			$(".pull-right.direct").css('color', "rgb(52, 152, 219)");
		} else if(row2 == good && row1 == good && row3 == good) {
			$(".pull-right.direct").text(good);
			$(".pull-right.direct").css('color', '#7ED321');
		}
	}
	statusLuckyDirect();

	function statusPOS() {
		var good = "Operational";
		var partial = "Partial Outage";
		var maint = "Under Maintenance";
		var degraded = "Degraded Performance";
		var major = "Major Outage";

		var row1 = $(".pull-right.sale1").text().trim();
		var row2 = $(".pull-right.sale2").text().trim();
		var row3 = $(".pull-right.sale3").text().trim();

		// The status ladder, strongest status first
		if(row2 == major || row1 == major || row3 == major) {
			$(".pull-right.sale").text(major);
			$(".pull-right.sale").css('color', "rgb(231, 76, 60)");
		} else if(row2 == partial || row1 == partial || row3 == partial) {
			$(".pull-right.sale").text(partial);
			$(".pull-right.sale").css('color', '#e67e22');
		} else if(row2 == degraded || row1 == degraded || row3 == degraded) {
			$(".pull-right.sale").text(degraded);
			$(".pull-right.sale").css('color', 'rgb(241, 196, 15)');
		} else if(row2 == maint || row1 == maint || row3 == maint) {
			$(".pull-right.sale").text(maint);
			$(".pull-right.sale").css('color', "rgb(52, 152, 219)");
		} else if(row2 == good && row1 == good && row3 == good) {
			$(".pull-right.sale").text(good);
			$(".pull-right.sale").css('color', '#7ED321');
		}
	}
	statusPOS();

	function statusEcom() {
		var good = "Operational";
		var partial = "Partial Outage";
		var maint = "Under Maintenance";
		var degraded = "Degraded Performance";
		var major = "Major Outage";

		var row1 = $(".pull-right.ecom1").text().trim();
		var row2 = $(".pull-right.ecom2").text().trim();
		var row3 = $(".pull-right.ecom3").text().trim();

		// The status ladder, strongest status first
		if(row2 == major || row1 == major || row3 == major) {
			$(".pull-right.ecom").text(major);
			$(".pull-right.ecom").css('color', "rgb(231, 76, 60)");
		} else if(row2 == partial || row1 == partial || row3 == partial) {
			$(".pull-right.ecom").text(partial);
			$(".pull-right.ecom").css('color', '#e67e22');
		} else if(row2 == degraded || row1 == degraded || row3 == degraded) {
			$(".pull-right.ecom").text(degraded);
			$(".pull-right.ecom").css('color', 'rgb(241, 196, 15)');
		} else if(row2 == maint || row1 == maint || row3 == maint) {
			$(".pull-right.ecom").text(maint);
			$(".pull-right.ecom").css('color', "rgb(52, 152, 219)");
		} else if(row2 == good && row1 == good && row3 == good) {
			$(".pull-right.ecom").text(good);
			$(".pull-right.ecom").css('color', '#7ED321');
		}
	}
	statusEcom();

	function statusCorp() {
		var good = "Operational";
		var partial = "Partial Outage";
		var maint = "Under Maintenance";
		var degraded = "Degraded Performance";
		var major = "Major Outage";

		var row1 = $(".pull-right.corp1").text().trim();
		var row2 = $(".pull-right.corp2").text().trim();

		// The status ladder, strongest status first
		if(row2 == major || row1 == major) {
			$(".pull-right.corp").text(major);
			$(".pull-right.corp").css('color', "rgb(231, 76, 60)");
		} else if(row2 == partial || row1 == partial) {
			$(".pull-right.corp").text(partial);
			$(".pull-right.corp").css('color', '#e67e22');
		} else if(row2 == degraded || row1 == degraded) {
			$(".pull-right.corp").text(degraded);
			$(".pull-right.corp").css('color', 'rgb(241, 196, 15)');
		} else if(row2 == maint || row1 == maint) {
			$(".pull-right.corp").text(maint);
			$(".pull-right.corp").css('color', "rgb(52, 152, 219)");
		} else if(row2 == good && row1 == good) {
			$(".pull-right.corp").text(good);
			$(".pull-right.corp").css('color', '#7ED321');
		}
	}
	statusCorp();

	// var object;
	// var table1 = $(".OpsGenie");

	// function getStatus(acknowledged) {
	// 	if(acknowledged == false) {
	// 		return "Open";
	// 	} else {
	// 		return "Ack'ed";
	// 	}
	// }

	// function alertType(message, i) {
	// 	if((message.indexOf("Critical alert:")) != -1) {
	// 		$("#row"+i).css('background-color','#b01801');
	// 	} else if(message.indexOf("Medium alert:") != -1) {
	// 		$("#row"+i).css('background-color', '#ffb027');
	// 	} else if(message.indexOf("Low alert:") != -1) {
	// 		$("#row"+i).css('background-color', '#59ad19');
	// 	} else {
	// 		$("#row"+i).css('background', '-webkit-linear-gradient(left, #25c481, #25b7c4)');
	// 		$("#row"+i).css('background', 'linear-gradient(to right, #25c481, #25b7c4)');
	// 	}
	// }
	// function addRow(i) {
	// 	return "row"+i;
	// }

	// Retrieve saved data
	function getStatus() {
		var xhr = new XMLHttpRequest();
	                
	    xhr.open("GET", "https://no79f0tvp3.execute-api.us-east-2.amazonaws.com/Test", true);

	    xhr.addEventListener("readystatechange", function () {
	   		if (this.readyState === 4) {
	        	if(this.status == 200) { // When its successful
	        		var data = this.responseText;
	            	console.log(data);
	            	var parser = new DOMParser();
	            	var xmlDoc = parser.parseFromString(data, "application/xml");

	            	// Gets the status from normal page here TODO
					$(".pull-right.direct1").text(xmlDoc.getElementsByTagName("ns1:direct1")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.direct1"));
					$(".pull-right.direct2").text(xmlDoc.getElementsByTagName("ns1:direct2")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.direct2"));
					$(".pull-right.direct3").text(xmlDoc.getElementsByTagName("ns1:direct3")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.direct3"));
					$(".pull-right.sale1").text(xmlDoc.getElementsByTagName("ns1:sale1")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.sale1"));
					$(".pull-right.sale2").text(xmlDoc.getElementsByTagName("ns1:sale2")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.sale2"));
					$(".pull-right.sale3").text(xmlDoc.getElementsByTagName("ns1:sale3")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.sale3"));
					$(".pull-right.ecom1").text(xmlDoc.getElementsByTagName("ns1:ecom1")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.ecom1"));
					$(".pull-right.ecom2").text(xmlDoc.getElementsByTagName("ns1:ecom2")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.ecom2"));
					$(".pull-right.ecom3").text(xmlDoc.getElementsByTagName("ns1:ecom3")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.ecom3"));
					$(".pull-right.corp1").text(xmlDoc.getElementsByTagName("ns1:corp1")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.corp1"));
					$(".pull-right.corp2").text(xmlDoc.getElementsByTagName("ns1:corp2")[0].childNodes[0].nodeValue);
					determineColor($(".pull-right.corp2"));

					statusLuckyDirect();
					statusEcom();
					statusCorp();
					statusPOS();
	        	} else {
	            	console.log("Failure: " + this.status);
	             	// Print a message saying not successful, and tell them to retry
	         	}
	    	}
	    });

	    xhr.send(null);
	}
	getStatus();

	// Check if there are criticals, if there are set the status to under Maintenance if its operational
	function getCriticals() {
		var xhr = new XMLHttpRequest();

		var borisMatch = ["Boris", "boris"];
		var ecomMatch = ["Ecom", "ecom", "Ecommerce", "ecommerce", "eCommerce"];
		var ldorderMatch = ["Allocation", "allocation", "LD Order"];
		var luckybrandMatch = ["Site", "site", "website", "Website", "www.LuckyBrand.com"];
		var manhattanMatch = ["Atom", "atom", "Manhattan", "manhattan", "Molecule", "molecule"];
		var mistoreMatch = ["MiStore", "mistore"];
		var ordersMatch = ["Order", "order"];
		var pickupMatch = ["Pickup", "pickup"];
		var pricingMatch = ["Pricing", "pricing", "Price", "price"];
		var promotionsMatch = ["Promotion", "promotion", "Clearance", "clearance", "Tax Free", "tax free", "Discount", "discount", "promo", "Promo", "Markdown", "markdown"];


		xhr.addEventListener("readystatechange", function () {
		  if (this.readyState === 4) {
		  	if(this.status == 200) {
		  		object = JSON.parse(this.responseText);
		  		
		  		for(let incident of object) {
		  			var name = incident.name;
		  			var description = incident.description_no_html;

		  			// Checks if the critical ticket matches any of these catagories, if it does set to partial outage
		  			if(setStatuses(borisMatch, name, description, ".pull-right.direct1")) {

		  			}
		  			else if(setStatuses(ecomMatch, name, description, ".pull-right.ecom1")) {

		  			}
		  			else if(setStatuses(ldorderMatch, name, description, ".pull-right.direct2")) {

		  			}
		  			else if(setStatuses(luckybrandMatch, name, description, ".pull-right.ecom3")) {

		  			}
		  			else if(setStatuses(manhattanMatch, name, description, ".pull-right.corp1")) {

		  			}
		  			else if(setStatuses(mistoreMatch, name, description, ".pull-right.sale1")) {

		  			}
					else if(setStatuses(ordersMatch, name, description, ".pull-right.ecom2")) {

					}
					else if(setStatuses(pickupMatch, name, description, ".pull-right.direct3")) {

					}
					else if(setStatuses(pricingMatch, name, description, ".pull-right.sale3")) {

					}
					else if(setStatuses(promotionsMatch, name, description, ".pull-right.sale2")) {

					}
		  		}

		  		// Update the status on header
		  		statusLuckyDirect();
		  		statusPOS();
		  		statusEcom();
		  		statusCorp();
		  		saveStatus();

		  	} else {
		  		console.log("Not successful status!");
		  	}
		  }
		});

		xhr.open("GET", "https://xalsmz1aph.execute-api.us-east-2.amazonaws.com/Test/criticalpriority", true); // Original

		xhr.send();
	}

	// Sets the status to Under Maintenace if its operational
	function setStatuses(match, name, description, status) {

		for(var i = 0; i < match.length; i++) {
			if(name.indexOf(match[i]) != -1 || description.indexOf(match[i]) != -1) {
				if($(status).text() != "Degraded Performance" &&  $(status).text() != "Partial Outage" && $(status).text() != "Major Outage") {
					$(status).text("Under Maintenance");
					$(status).css('color', 'rgb(52, 152, 219)');
					return true;
				}
			}
		}
		return false;
	}

	getCriticals();

	function saveStatus() {

		var direct1 = $(".pull-right.direct1").text().trim();
		var direct2 = $(".pull-right.direct2").text().trim();
		var direct3 = $(".pull-right.direct3").text().trim();
		var sale1 = $(".pull-right.sale1").text().trim();
		var sale2 = $(".pull-right.sale2").text().trim();
		var sale3 = $(".pull-right.sale3").text().trim();
		var ecom1 = $(".pull-right.ecom1").text().trim();
		var ecom2 = $(".pull-right.ecom2").text().trim();
		var ecom3 = $(".pull-right.ecom3").text().trim();
		var corp1 = $(".pull-right.corp1").text().trim();
		var corp2 = $(".pull-right.corp2").text().trim();

		var data = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n\t<StatusInfo xmlns=\"StatusInfoXML\">\r\n\t\t<direct1>"+direct1+"</direct1>\r\n\t\t<direct2>"+direct2+"</direct2>\r\n\t\t<direct3>"+direct3+"</direct3>\r\n\t\t<sale1>"+sale1+"</sale1>\r\n\t\t<sale2>"+sale2+"</sale2>\r\n\t\t<sale3>"+sale3+"</sale3>\r\n\t\t<ecom1>"+ecom1+"</ecom1>\r\n\t\t<ecom2>"+ecom2+"</ecom2>\r\n\t\t<ecom3>"+ecom3+"</ecom3>\r\n\t\t<corp1>"+corp1+"</corp1>\r\n\t\t<corp2>"+corp2+"</corp2>\r\n\t</StatusInfo>";
		console.log(data);

		var xhr = new XMLHttpRequest();

		xhr.addEventListener("readystatechange", function () {
			if (this.readyState === 4 && this.status == 200) {
			  	console.log(this.responseText);
			}
		});

		xhr.open("POST", "https://no79f0tvp3.execute-api.us-east-2.amazonaws.com/Test", true);
		
		xhr.send(data);
	}

</script>

</body>
</html>
